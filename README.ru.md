# Развёртывание SSH-бастиона Codex

*English version: see [README.md](README.md).*  
*Подробные значения переменных и примеры находятся в [AGENTS.md — Подготовка кластера](AGENTS.md#подготовка-кластера) и [AGENTS.md — Подготовка workspace](AGENTS.md#подготовка-workspace).* 

## 1. Архитектура и поток трафика
- **Многопрыжковая цепочка.** Рабочее пространство Codex инициирует SSH (при необходимости через корпоративный прокси), выходит на публичную HTTPS-точку `<keen-dns-domain>`, далее попадает на закреплённый NodePort `<node-ip>:<node-port>`, входит в Pod SSH-бастиона и уже оттуда прыгает к целевой инфраструктуре через объявленные ProxyJump-цепочки.
- **Роль Pod-а.** Бастион принимает входящие SSH-сессии, применяет политики промежуточных переходов, формирует инвентаризацию для пользователей workspace, публикует проверки работоспособности и сохраняет телеметрию в `reports/`. Он работает с образом из `SSH_BASTION_IMAGE`, учитывая переопределения реестра через `SSH_IMAGE_REGISTRY`.
- **Автоматический захват маршрутов.** В workspace устанавливается обёртка `ssh`, которая фиксирует каждую успешную последовательность прыжков, экспортирует их в `reports/ssh-routes.json` и обновляет уведомления в `AGENTS.md`, чтобы новые сессии использовали ту же топологию.
- **Набор скриптов.**
  - `scripts/deploy-ssh-bastion.sh` разворачивает Pod, сервис и конфигурационные карты с учётом переменных ниже.
  - `scripts/setup-codex-workspace.sh` готовит окружение Codex, записывает SSH-конфиги, загружает секреты и регистрирует прокси-коннектор.
  - `scripts/codex-hostctl` управляет алиасами хостов, ProxyJump-цепочками и синхронизацией метаданных между workspace и репозиторием.

## 2. Секреты и требования к переменным окружения
### 2.1 Общие входные данные
| Имя | Область | Описание |
| --- | --- | --- |
| `SSH_KEY` | Секрет | Приватный ключ workspace для аутентификации на бастионе. Храните его в хранилище секретов проекта; публичная часть должна быть в `authorized_keys` бастиона. |

### 2.2 Переменные администратора
| Имя | Значение по умолчанию | Назначение |
| --- | --- | --- |
| `SSH_NAMESPACE` | `codex-ssh` | Namespace, содержащий развёртывание бастиона. |
| `SSH_DEPLOYMENT_NAME` | `codex-ssh` | Имя deployment-а, по которому отслеживается статус раскатки. |
| `SSH_SERVICE_NAME` | `codex-ssh` | Сервис, публикующий Pod на `<node-ip>:<node-port>`. |
| `SSH_SERVICE_TYPE` | `NodePort` | Тип сервиса, через который доступен Pod. |
| `SSH_SERVICE_NODE_PORT` | — | Закреплённый NodePort, передаваемый в workspace (плейсхолдер `<node-port>` при незаданном значении). |
| `SSH_BASTION_IMAGE` | См. AGENTS | Контейнерный образ для Pod-а. |
| `SSH_IMAGE_REGISTRY` | Опционально | Переопределение реестра при загрузке образа (см. раздел 5). |

### 2.3 Переменные workspace
| Имя | Источник | Описание |
| --- | --- | --- |
| `SSH_BASTION_HOST` | Секрет или переменная | Внешнее имя бастиона (в документации используйте `<keen-dns-domain>`). |
| `SSH_BASTION_PORT` | Секрет или переменная | Публичный NodePort, используемый workspace (плейсхолдер `<node-port>`). |
| `SSH_BASTION_USER` | Секрет или переменная | Имя пользователя на бастионе, связанное с ключом `SSH_KEY`. |
| `SSH_BASTION_ENDPOINT` | Производная | Полная строка `user@host:port`, которую собирают вспомогательные скрипты; переопределяйте только при нестандартной маршрутизации. |
| `SSH_PROXY_URL` | Секрет | URL корпоративного прокси, через который должен идти workspace. Не задавайте, если обход не требуется. |
| `SSH_PROXY_CONNECT_LOG` | Переменная | Путь к логам прокси-коннектора (по умолчанию `reports/ssh-proxy.log`). |

## 3. Последовательность настройки
### 3.1 Дорожная карта администратора
1. Сгенерируйте ключевую пару SSH для workspace и пропишите публичную часть в конфигурации бастиона.
2. Экспортируйте необходимые переменные (см. раздел 2.2 и AGENTS) и выполните `scripts/deploy-ssh-bastion.sh` с машины, имеющей доступ к кластеру. Скрипт создаст все объекты, опубликует NodePort и сохранит метаданные подключения в `reports/`.
3. Передайте поддержке workspace плейсхолдеры `<keen-dns-domain>` и `<node-port>`. Конкретные значения храните вне репозитория и фиксируйте в [AGENTS.md](AGENTS.md) для внутреннего пользования.

### 3.2 Дорожная карта workspace
1. Занесите `SSH_KEY`, `SSH_PROXY_URL` и набор `SSH_BASTION_*` в раздел секретов проекта Codex.
2. Запускайте `scripts/setup-codex-workspace.sh` как установочный и обслуживающий хук. Помощник обновит `scripts/codex-hostctl`, установит обёртку `ssh`, пересоберёт `~/.ssh/config` и запишет ProxyJump-цепочки в `reports/ssh-inventory.md`.
3. Проверьте импортированные алиасы командой `scripts/codex-hostctl list`. Переименовывайте записи через `scripts/codex-hostctl rename <old> <new>`; каждое выполнение автоматически обновляет сводку в `AGENTS.md` workspace.
4. При появлении новых целевых систем перезапускайте скрипт, чтобы обновить трассировки маршрутов, инвентарь и заметки в AGENTS.

## 4. Интеграция с корпоративным прокси
- **Архитектура коннектора.** В `~/.ssh/config` прописывается `ProxyCommand`, который вызывает локальный коннектор. Он устанавливает HTTPS CONNECT к `SSH_PROXY_URL`, после чего прозрачно прокидывает SSH-трафик, не раскрывая учётные данные.
- **Необходимые параметры.** Укажите `SSH_PROXY_URL` (например, `https://<proxy-host>:<proxy-port>`). Дополнительно можно задать `SSH_PROXY_CONNECT_LOG` для расположения логов, `SSH_PROXY_SOCKET` для выбора Unix-сокета и `SSH_PROXY_STRICT=1`, чтобы падать при любой ошибке подключения.
- **Поведение обёртки `ssh`.** Все SSH-вызовы workspace идут через `scripts/ssh-wrapper`, установленный `setup-codex-workspace.sh`. Обёртка подставляет нужный `ProxyCommand`, отслеживает успешные многопрыжковые цепочки и добавляет подробные трассировки в `reports/ssh-routes.json` и файл логов прокси.
- **Диагностика.** Анализируйте `reports/ssh-proxy.log` для просмотра работы коннектора и проверяйте `reports/ssh-routes.json` для подтверждения построенных маршрутов. Скрипт настройки также переносит актуальный статус в `AGENTS.md` проекта.

## 5. Ручная сборка образа и настройка реестра
1. Подготовьте рабочую директорию с манифестами из `manifests/` и Dockerfile, соответствующим требованиям SSH-бастиона.
2. Соберите образ локально, например:
   ```bash
   docker build -t <registry>/<name>:tag .
   ```
3. Отправьте образ в свой реестр и экспортируйте `SSH_BASTION_IMAGE=<registry>/<name>:tag`, а также `SSH_IMAGE_REGISTRY=<registry>`, если кластер требует явного указания реестра.
4. Зафиксируйте выбранный реестр, тег и параметры развёртывания в [AGENTS.md — Подготовка кластера](AGENTS.md#подготовка-кластера), чтобы последующие администраторы использовали согласованные значения.

В этом README используются плейсхолдеры (`<keen-dns-domain>`, `<node-ip>`, `<node-port>`) для скрытия чувствительных данных. Подставляйте реальные значения только в закрытых каналах и следуйте рекомендациям из [AGENTS.md](AGENTS.md).
